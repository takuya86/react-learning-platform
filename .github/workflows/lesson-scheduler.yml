name: Weekly Lesson Generator

on:
  schedule:
    # Run every Monday at 00:00 UTC (09:00 JST)
    - cron: '0 0 * * 1'
  workflow_dispatch:
    inputs:
      max_lessons:
        description: 'Maximum number of lessons to generate'
        required: false
        default: '3'
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  check-pending:
    runs-on: ubuntu-latest
    outputs:
      has_pending: ${{ steps.check.outputs.has_pending }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for pending lessons
        id: check
        run: |
          pending_count=$(jq '[.lessons[] | select(.status == "pending")] | length' lessons.backlog.json)
          echo "Pending lessons: $pending_count"
          if [ "$pending_count" -gt 0 ]; then
            echo "has_pending=true" >> $GITHUB_OUTPUT
          else
            echo "has_pending=false" >> $GITHUB_OUTPUT
          fi

  generate-lessons:
    needs: check-pending
    if: needs.check-pending.outputs.has_pending == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate lesson scaffolds
        run: |
          max_lessons="${{ github.event.inputs.max_lessons || '3' }}"
          node tools/generate-lessons.mjs --max="$max_lessons"

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Validate generated lessons
        if: steps.changes.outputs.has_changes == 'true'
        run: npm run validate:lessons -- --strict

      - name: Get generated lesson titles and date
        id: titles
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          mdx_count=$(git diff --name-only | grep "\.mdx$" | wc -l | tr -d ' ')
          echo "MDX files changed: $mdx_count"
          if [ "$mdx_count" -eq 0 ]; then
            echo "No MDX files generated, skipping PR creation"
            echo "has_mdx=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "has_mdx=true" >> $GITHUB_OUTPUT
          titles=$(git diff --name-only | grep "\.mdx$" | xargs -I {} basename {} .mdx | tr '\n' ', ' | sed 's/,$//')
          echo "Generated lessons: $titles"
          echo "titles=$titles" >> $GITHUB_OUTPUT
          echo "date=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT

      - name: Get lesson statistics
        id: stats
        if: steps.changes.outputs.has_changes == 'true' && steps.titles.outputs.has_mdx == 'true'
        run: |
          # Get stats from backlog (after generation updates)
          pending=$(jq '[.lessons[] | select(.status == "pending")] | length' lessons.backlog.json)
          generated=$(jq '[.lessons[] | select(.status == "generated")] | length' lessons.backlog.json)
          published=$(jq '[.lessons[] | select(.status == "published")] | length' lessons.backlog.json)
          total=$(jq '.lessons | length' lessons.backlog.json)

          # This week's generation (Ubuntu/GNU date, UTC for consistency with ISO timestamps)
          week_start=$(date -u -d 'last monday' '+%Y-%m-%dT00:00:00Z')
          this_week=$(jq --arg date "$week_start" '[.lessons[] | select(.generatedAt != null and .generatedAt >= $date)] | length' lessons.backlog.json)

          # Top 3 tags (use []? to handle empty tags arrays safely)
          top_tags=$(jq -r '[.lessons[].tags[]?] | group_by(.) | map({tag: .[0], count: length}) | sort_by(-.count) | .[0:3] | map("\(.tag): \(.count)") | join(", ")' lessons.backlog.json)

          echo "pending=$pending" >> $GITHUB_OUTPUT
          echo "generated=$generated" >> $GITHUB_OUTPUT
          echo "published=$published" >> $GITHUB_OUTPUT
          echo "total=$total" >> $GITHUB_OUTPUT
          echo "this_week=$this_week" >> $GITHUB_OUTPUT
          echo "top_tags=$top_tags" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true' && steps.titles.outputs.has_mdx == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'feat: add lesson scaffolds (${{ steps.titles.outputs.titles }})'
          title: 'Weekly Lesson Generation: ${{ steps.titles.outputs.titles }}'
          body: |
            ## Automatically Generated Lesson Scaffolds

            This PR was automatically generated by the weekly lesson scheduler.

            ### Generated Lessons
            ${{ steps.titles.outputs.titles }}

            ---

            ## ğŸ“Š Backlog Statistics

            | Status | Count |
            |--------|-------|
            | Pending | ${{ steps.stats.outputs.pending }} |
            | Generated | ${{ steps.stats.outputs.generated }} |
            | Published | ${{ steps.stats.outputs.published }} |
            | **Total** | **${{ steps.stats.outputs.total }}** |

            - **This week**: ${{ steps.stats.outputs.this_week }} lessons generated
            - **Top tags**: ${{ steps.stats.outputs.top_tags }}

            ---

            ## Claude Code ã¸ã®æŒ‡ç¤º

            ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã«å¾“ã£ã¦TODOã‚’åŸ‹ã‚ã¦ãã ã•ã„ï¼š

            ### å¿…é ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³
            - **å­¦ç¿’ç›®æ¨™ï¼ˆObjectivesï¼‰**: å…·ä½“çš„ãƒ»æ¸¬å®šå¯èƒ½ãª3ã¤ã®ç›®æ¨™
            - **æœ€å°å‹•ä½œä¾‹ï¼ˆExampleï¼‰**: ã‚³ãƒ”ãƒšã§å‹•ãå®Œå…¨ãªã‚³ãƒ¼ãƒ‰
            - **è½ã¨ã—ç©´ï¼ˆPitfallsï¼‰**: å®Ÿå‹™ã§ã‚ˆãã‚ã‚‹2ã¤ä»¥ä¸Šã®ãƒŸã‚¹
            - **ç·´ç¿’å•é¡Œï¼ˆExercisesï¼‰**: é›£æ˜“åº¦é †ã«3å•ä»¥ä¸Š

            ### åˆ†é‡ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³
            - æœ¬æ–‡: 800ã€œ1500æ–‡å­—
            - ã‚³ãƒ¼ãƒ‰ä¾‹: å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³1ã€œ2å€‹
            - èª­äº†æ™‚é–“ãŒfrontmatterã®estimatedMinutesã«åã¾ã‚‹ã“ã¨

            ### ç¦æ­¢äº‹é …
            - å¤–éƒ¨è¨˜äº‹ãƒ»å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ä¸¸å†™ã—ç¦æ­¢
            - å¤ã„Reactï¼ˆã‚¯ãƒ©ã‚¹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã€ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ï¼‰ã¯é¿ã‘ã‚‹
            - æœªæ¤œè¨¼ã®ã‚³ãƒ¼ãƒ‰ã¯ç¦æ­¢ï¼ˆå¿…ãšå‹•ä½œç¢ºèªï¼‰

            ### å“è³ªãƒã‚§ãƒƒã‚¯
            ```bash
            npm run validate:lessons  # ãƒãƒƒã‚¯ãƒ­ã‚°æ¤œè¨¼
            npm run typecheck         # å‹ãƒã‚§ãƒƒã‚¯
            npm run test:run          # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
            npm run build             # ãƒ“ãƒ«ãƒ‰ç¢ºèª
            ```

            ---

            ### Next Steps
            1. `src/content/lessons/` ã®MDXãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†
            2. ä¸Šè¨˜ã®å“è³ªãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
            3. ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾Œãƒãƒ¼ã‚¸

            ---
            Generated by GitHub Actions
          branch: lesson/weekly-${{ steps.titles.outputs.date }}-${{ github.run_id }}
          delete-branch: true
          labels: |
            lesson
            auto-generated
